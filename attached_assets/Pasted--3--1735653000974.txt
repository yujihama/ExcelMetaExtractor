## 3. シート内「領域（エリア）」抽出

シート内のセルがどのような「エリア」に該当するかを判定し、それぞれを適切に扱うための機能です。  
**エリアの種類**としては大きく「テーブル領域」「テキスト領域」「画像・図形領域」などがあります。

### 3-1. どのエリアに該当するかを判定する方法

1. **ルールベース**  
   - 「複数行×複数列の連続した数値や文字列を含む→テーブルらしい」  
   - 「数行のみのテキストセルが縦に並んでいて、列が少ない→メモ書き（テキスト）らしい」  
   - 「drawing.xml で座標情報が見つかる→画像・図形領域」  
   - など、固定ロジックで機械的に判定。

2. **LLM活用**  
   - シート全体（または抽出したセル情報）をテキスト化・JSON化し、LLMに「どの行列範囲が表（テーブル）で、どこがメモ、どこが画像？」と問う。  
   - LLMが返すテーブル範囲候補を再度ルールベースと照合し、最終確定。  
   - 複合ヘッダーなどの特殊パターンも「ここはヘッダーが2行になっている」とLLMが気づいて補正してくれる場合がある。

3. **ハイブリッドアプローチ**  
   - まずルールベースで90%程度の判定をし、際どいケース（結合セルが多い、セルがスカスカな表など）だけLLMに投げる。  
   - 大量のファイルを処理するときなど、性能と精度の両立を図れる。

下記各機能は、上記のエリア判定が終わったあと、具体的に取得・記録する内容です。

---

### 3-2. テーブル領域

| 機能名                           | 内容・目的                                                                                                                                           | 例                                                                                                            |
|---------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------|
| 3-2-1. Excel「テーブル機能」定義  | 公式の「テーブル」として定義されている範囲 (`tableN.xml` の `ref="A1:C20"` など) を解析。<br/>ヘッダー行数や列名も取得。                                                                 | - `"range": "A1:C20", "headerRowsCount": 1, "tableColumns": ["Date", "Item", "Amount"]`                        |
| 3-2-2. テーブル自動判定 (LLM含む) | Excel「テーブル機能」が設定されていないが実質テーブルとして使われているセルの範囲を、LLMまたはルールベースで抽出。<br/>行列の分布から表らしき領域を見つけ出し、ヘッダー候補を判定。                                                 | - `"detectedTables": [{"range": "A1:E10", "headerType": "single"}, ...]`                                       |
| 3-2-3. 複合ヘッダー・結合セル対応  | 1行ではなく2行以上のヘッダー、または結合セルを含む複雑なレイアウトを判定・保持。<br/>LLMとの連携例: 結合セル範囲をLLMに説明し、「ここは売上と年度を表している複合ヘッダー」といった推定を返してもらう。                          | - `"headerStructure": {"headerRowsCount": 2, "mergedCells": [{"range":"A1:B1"}]}`                              |
| 3-2-4. ヘッダー・データ部・合計部区分 | テーブル領域のどの行がヘッダーで、どの行がデータ本体、どの行が合計部かを区分し、**重要セル**のみ抽出する設定も可能。                                                                     | - `"headerRows": [1], "dataRows": [2..9], "totalRows": [10]"`                                                 |
| 3-2-5. テーブル列・セル情報       | 抽出したテーブルの各列・セルの値や数式を取得。ただし大容量の場合は必要最小限（ヘッダー、合計欄など）だけに絞る方針も。<br/>LLMとの連携例: 「この列は金額か？日付か？」をLLMに判定させ、監査での整合性チェックに使う。 | - `"cells": [ {"row":2, "col":1, "value": "2024-01-01", "formula": null}, ... ]`                               |

---

### 3-3. テキスト領域

| 機能名                      | 内容・目的                                                                                                                     | 例                                                                                           |
|----------------------------|-----------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------|
| 3-3-1. テキストブロック抽出  | 行列の分布から表でも画像でもないセル群を“テキスト領域”としてまとめる。<br/>LLMとの連携例: 抽出したテキストを要約させて「会議メモ」「説明コメント」「ただの空欄？」などを識別する。         | - `"range": "G1:G10", "content": "ここに月次のメモ..."`, `"classification": "meeting notes"` |
| 3-3-2. 装飾・スタイル情報   | フォント色や太字・斜体などの装飾情報を取得するかどうか。不要なら省略可。<br/>LLM連携例: 太字の単語を抽出してハイライト意味を推測するなど。                                  | - `"style": {"bold": true, "color": "#FF0000"}`                                              |

---

### 3-4. 画像・図形領域

| 機能名                        | 内容・目的                                                                                                                                                                                                 | 例                                                                                                    |
|------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| 3-4-1. 画像ファイル情報の取得   | `drawingN.xml` と `.rels` を解析して、画像ファイル(`.png`, `.jpeg` など)とのパス紐付けを取得。                                                                                                           | - `"imageName": "image1.png", "targetPath": "xl/media/image1.png"`                                    |
| 3-4-2. 画像の座標・サイズ情報取得 | `<xdr:from>`/`<xdr:to>` などを解析し、画像がシート上のどの行列にかかっているか特定。<br/>LLMとの連携例: Alt Textの文言をLLMに解釈させ、「この画像は売上グラフか、概念図か？」を推定。                                           | - `"from_row": 3, "from_col": 2, "to_row": 8, "to_col": 5`, `"altText": "Sales trend chart"`          |
| 3-4-3. 図形(Shape)・グラフ(Chart)解析 | 画像以外の図形要素（テキストボックス、SmartArtなど）やグラフ（Chart）の種類や参照範囲を解析。<br/>LLM連携例: グラフタイトル・ラベルをLLMに投げて、どのテーブルと関連があるかを推測する。                                                     | - `"chartType": "bar", "dataRange": "A1:B10", "title": "売上推移グラフ"`                               |

